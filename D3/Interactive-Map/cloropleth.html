<meta charset="utf-8">
<style>

.states {
  strok: black
  fill: none;
}
.d3-tip {
  line-height: 1;
  padding: 12px;
  background: rgba(220,220,220, 0.8);
  border-radius: 2px
  font-weight: 10000;
}

</style>
<svg width="960" height="455"></svg>
<script type="text/javascript" src="../lib/d3.v5.min.js"></script>
<script type="text/javascript" src="../lib/d3-scale-chromatic.v1.min.js"></script>
<script type="text/javascript" src="../lib/topojson.v2.min.js"></script>
<script type="text/javascript" src="../lib/d3-simple-slider.min.js"></script>
<script type="text/javascript" src="../lib/d3-tip.min.js"></script>

<div class="container">
</div>
<h2>Year</h2>
  <div class="row align-items-center">
    <div class="col-sm-2"><p id="value-time"></p></div>
    <div class="col-sm"><div id="slider-time"></div></div>
  </div>
</div>

<script>
var dataTime = d3.range(0,6).map(function(d) {
  return new Date(2010 + d, 10, 3);
});

var sliderTime = d3
  .sliderBottom()
  .min(d3.min(dataTime))
  .max(d3.max(dataTime))
  .step(1000 * 60 * 60 * 24 * 365)
  .width(300)
  .tickFormat(d3.timeFormat('%Y'))
  .tickValues(dataTime)
  .default(new Date(2010, 10, 3))
  .on('onchange', val => {
    change_map(d3.timeFormat('%Y')(val))
  });


//INitialize
var gTime = d3
  .select('div#slider-time')
  .append('svg')
  .attr('width', 500)
  .attr('height', 100)
  .append('g')
  .attr('transform', 'translate(30,30)');

gTime.call(sliderTime);


var svg = d3.select("svg"),
  width = +svg.attr("width"),
  height = +svg.attr("height");



var earthquakes1 = d3.map();
var regions = {}
var projection1 = d3.geoAlbersUsa()
    .scale(800);
var path1 = d3.geoPath().projection(projection1);

var promises = [
  d3.json("states-10m.json"),
  d3.csv("state-earthquakes.csv", function(d) {
    earthquakes1.set(d.States, d["2010"])
    regions[d.States] = d.Region;})
]
Promise.all(promises).then(ready)

function ready([us]) {
    console.log(regions)

    var max = Math.max.apply(null, Object.values(earthquakes1))
    var ref = d3.scaleLog()
        .domain([1, max])
        .range([1,max]);

    var color = d3.scaleLog()
        .domain([1, max])
        .range(["#f7fbff", "#08306b"]);

    var scale = [[ref.invert(max/9),"rgb(247, 251, 255)"], [ref.invert(2*max/9),"rgb(217, 226, 237)"], [ref.invert(3*max/9),"rgb(187, 200, 218)"], [ref.invert(4*max/9),"rgb(157, 175, 200)"],
    [ref.invert(5*max/9),"rgb(128, 150, 181)"], [ref.invert(6*max/9),"rgb(98, 124, 163)"], [ref.invert(7*max/9),"rgb(68, 99, 144)"], [ref.invert(8*max/9),"rgb(38, 73, 126)"],
    [ref.invert(max),"rgb(8, 48, 107)"]]


    var g = svg.append("g")
        .attr("class", "key")
        .attr("transform", "translate(875,40)");

    g.selectAll("rect")
      .data(scale)
      .enter().append("rect")
        .attr("x", 0)
        .attr("width", 15)
        .attr("y", function(d,i) {
          return i*30; })
        .attr("height", 25)
        .attr("fill", function(d){return d[1]});

    g.selectAll("text")
      .data(scale)
      .enter().append("text")
        .attr("class", "ticks")
        .attr("x", 20)
        .attr("y", function(d,i) {return 17+i*30; })
        .text(function(d){ return parseInt(d[0])})

    g.append("text")
        .attr("class", "caption")
        .attr("x", -50)
        .attr("y", -10)
        .attr("fill", "#000")
        .attr("text-anchor", "start")
        .attr("font-weight", "bold")
        .text("Earthquakes rate");

    var tip = d3.tip()
      .attr('class', 'd3-tip')
      .offset([70, -100])
      .html(function(d) {
        var content =`
            <table style="margin-top: 2.5px;">
                    <tr><td>State: </td><td style="text-align: right">` +d.properties.name + `</td></tr>
                    <tr><td>Region: </td><td style="text-align: right">` + regions[d.properties.name] + `</td></tr>
                    <tr><td>Year: </td><td style="text-align: right">` + "2010" + `</td></tr>
                    <tr><td>Earthquakes: </td><td style="text-align: right">` + earthquakes1["$"+d.properties.name] + `</td></tr>
            </table>
            `;
                return content;})

    svg.call(tip)

    svg.append("g")
        .attr("class", "states")
      .selectAll("path")
      .data(topojson.feature(us, us.objects.states).features)
      .enter().append("path")
          .attr("stroke", "black")
          .attr("fill", function(d) {
            return color(earthquakes1.get(d.properties.name))})
          .attr("d", path1)
      .on('mouseover', tip.show)
      .on('mouseout', tip.hide);

    g.append("text")
        .attr("class", "name")
        .attr("x", -50)
        .attr("y", 400)
        .text("hcornwell3");
}

function change_map(y){

  svg.selectAll("*").remove()

  var promises = [
    d3.json("states-10m.json"),
    d3.csv("state-earthquakes.csv", function(d) {earthquakes1.set(d.States, +d[y])})
  ]
  Promise.all(promises).then(ready)

  function ready([us]) {

      var max = Math.max.apply(null, Object.values(earthquakes1))
      var ref = d3.scaleLog()
          .domain([1, max])
          .range([1,max]);

      var color = d3.scaleLog()
          .domain([1, max])
          .range(["#f7fbff", "#08306b"]);

      var scale = [[ref.invert(max/9),"rgb(247, 251, 255)"], [ref.invert(2*max/9),"rgb(217, 226, 237)"], [ref.invert(3*max/9),"rgb(187, 200, 218)"], [ref.invert(4*max/9),"rgb(157, 175, 200)"],
      [ref.invert(5*max/9),"rgb(128, 150, 181)"], [ref.invert(6*max/9),"rgb(98, 124, 163)"], [ref.invert(7*max/9),"rgb(68, 99, 144)"], [ref.invert(8*max/9),"rgb(38, 73, 126)"],
      [ref.invert(max),"rgb(8, 48, 107)"]]


      var g = svg.append("g")
          .attr("class", "key")
          .attr("transform", "translate(875,40)");

      g.selectAll("rect")
        .data(scale)
        .enter().append("rect")
          .attr("x", 0)
          .attr("width", 15)
          .attr("y", function(d,i) {
            return i*30; })
          .attr("height", 25)
          .attr("fill", function(d){return d[1]});

      g.selectAll("text")
        .data(scale)
        .enter().append("text")
          .attr("class", "ticks")
          .attr("x", 20)
          .attr("y", function(d,i) {return 17+i*30; })
          .text(function(d){ return parseInt(d[0])})

      g.append("text")
          .attr("class", "caption")
          .attr("x", -50)
          .attr("y", -10)
          .attr("fill", "#000")
          .attr("text-anchor", "start")
          .attr("font-weight", "bold")
          .text("Earthquakes rate");



      var tip = d3.tip()
        .attr('class', 'd3-tip')
        .offset([70,-100])
        .html(function(d) {
          var content =`
              <table style="margin-top: 2.5px;">
                      <tr><td>State: </td><td style="text-align: right">` +d.properties.name + `</td></tr>
                      <tr><td>Region: </td><td style="text-align: right">` + regions[d.properties.name] + `</td></tr>
                      <tr><td>Year: </td><td style="text-align: right">` + y + `</td></tr>
                      <tr><td>Earthquakes: </td><td style="text-align: right">` + earthquakes1["$"+d.properties.name] + `</td></tr>
              </table>
              `;
                  return content;})

      svg.call(tip)

      svg.append("g")
          .attr("class", "states")
        .selectAll("path")
        .data(topojson.feature(us, us.objects.states).features)
        .enter().append("path")
            .attr("stroke", "black")
            .attr("fill", function(d) {
              return color(earthquakes1["$"+d.properties.name])})
            .attr("d", path1)
        .on('mouseover', tip.show)
        .on('mouseout', tip.hide);


  }

}

</script>
